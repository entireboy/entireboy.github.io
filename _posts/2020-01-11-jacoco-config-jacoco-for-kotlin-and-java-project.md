---
layout: post
title:  "[JaCoCo] 코틀린과 자바 프로젝트에 JaCoCo 설정하기"
date:   2020-01-11 22:18:00 +0900
published: true
categories: [ test ]
tags: [ jacoco, test, report, kotlin, java, gradle, project, junit ]
---

[JaCoCo](https://www.jacoco.org/jacoco/)는 Java 코드의 커버리지를 체크하는 라이브러리이다. 여기서는 Java 코드와 Kotlin 코드가 섞인 프로젝트를 함께 커버리지 체크하는 JaCoCo 설정을 살펴본다. (사실 자꾸 까먹어서 기록용..)

이전 버전 JaCoCo 같은 경우는 Java와 Kotlin 등 여러 언어의 소스가 섞여 있을 때는 [소스 경로를 모두 체크하도록 설정](http://vgaidarji.me/blog/2017/12/20/how-to-configure-jacoco-for-kotlin-and-java-project/)해 줘야 했던 것 같지만, 지금(v0.8.5)은 큰 설정 없이 사용할 수 있다.


# JaCoCo 플러그인 추가

Gradle 설정에 JaCoCo 플러그인을 추가하고, [플러그인 설정](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.plugins.JacocoPluginExtension.html)을 한다.

```kotlin
plugins {
  jacoco
}

jacoco {
  // JaCoCo 버전
  toolVersion = "0.8.5"

//  테스트결과 리포트를 저장할 경로 설정
//  reportsDir = file("$buildDir/customJacocoReportDir")
}
```

`reportsDir`로 테스트 결과 리포트를 저장할 경로를 바꿀 수 있다. default는 `${project.reporting.baseDir}/jacoco` 이다.


# Gradle task 설정 - 결과 리포트 저장과 커버리지 체크

JaCoCo 플러그인에는 `jacocoTestReport`와 `jacocoTestCoverageVerification` task가 있다.

- [jacocoTestReport](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.tasks.JacocoReport.html): JaCoCo 테스트 결과를 리포트 형태로 저장하는 task이다. html 파일로도 떨궈줘서 쉽게 확인할 수 있다.
- [jacocoTestCoverageVerification](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.tasks.JacocoCoverageVerification.html): 내가 원하는 커버리지 까지 체크가 됐는지 확인해 주는 task이다. 브랜치 커버리지를 최소한 80% 이상으로 유지하고 싶다면, 이 task를 설정하고 실행하면 된다. `test` task와 같이 성공/실패로 결과를 보여준다.

```kotlin
tasks.jacocoTestReport {
  reports {
    // 원하는 리포트를 켜고 끌 수 있다
    html.isEnabled = true
    xml.isEnabled = false
    csv.isEnabled = false

//  각 리포트 타입 마다 리포트 저장 경로를 설정할 수 있다
//  html.destination = file("$buildDir/jacocoHtml")
//  xml.destination = file("$buildDir/jacoco.xml")
  }
}

tasks.jacocoTestCoverageVerification {
// 이 커버리지 기준은 이 글의 맨 아래에서 다시 설명하겠다.
  violationRules {
    rule {
      limit {
        maximum = "0.5".toBigDecimal()
      }
    }
  }
}
```

그리고 JaCoCo 관련 task가 실행될 때 기존에 만들어 졌던 파일 때문에 정상적으로 저장되지 않을 수 있어서 `test` task에 다음 설정을 추가해 준다. 그러면 기존 파일을 제거하고 제대로 저장하게 된다. ([JaCoCo specific task configuration](https://docs.gradle.org/current/userguide/jacoco_plugin.html#sec:jacoco_specific_task_configuration))

```kotlin
tasks.test {
  extensions.configure(JacocoTaskExtension::class) {
    destinationFile = file("$buildDir/jacoco/jacoco.exec")
  }
}
```

아래 코드는 플러그인에서 `test` task에 default로 설정된 값들이다. `destinationFile`처럼 오버라이드 할 수 있다. ([JacocoTaskExtension](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.plugins.JacocoTaskExtension.html) 참고)

```kotlin
tasks.getByName<Test>("test") {
    extensions.configure(JacocoTaskExtension::class) {
        isEnabled = true
        destinationFile = file("$buildDir/jacoco/$name.exec")
        includes = listOf()
        excludes = listOf()
        excludeClassLoaders = listOf()
        isIncludeNoLocationClasses = false
        sessionId = "<auto-generated value>"
        isDumpOnExit = true
        classDumpDir = null
        output = JacocoTaskExtension.Output.FILE
        address = "localhost"
        port = 6300
        isJmx = false
    }
}
```

테스트를 JUnit5로 작생했기 때문에 함께 동작할 수 있도록 다음 설정을 해준다. `test` task 뿐만 아니라 모든 `Test` 타입의 task에서는 JUnit을 사용한다고 Gradle에 알려준다.

```kotlin
tasks.withType<Test> {
    useJUnitPlatform()
}
```


# 코드 준비와 테스트 실행

JaCoCo 테스트를 돌려볼 소스 코드와 테스트 코드를 준비한다. 테스트는 JUnit5로 작성됐다.

```java
// src/main/java/kr/leocat/test/kotlinjacocosample/JavaFoo.java
package kr.leocat.test.kotlinjacocosample;

public class JavaFoo {

    public String hello(String name) {
        switch (name) {
            case "펭":
                return "하";
            case "hello":
                return "world";
            default:
                return "no one";
        }
    }

    public void callMe() {
        System.out.println("Please, call me");
    }

}
```

```java
// src/test/java/kr/leocat/test/kotlinjacocosample/JavaFooTest.java
package kr.leocat.test.kotlinjacocosample;

import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

class JavaFooTest {

    private JavaFoo javaFoo = new JavaFoo();

    @Test
    public void partiallyCoveredHelloMethodTest() {
        String actual = javaFoo.hello("펭");
        assertEquals(actual, "하");
    }

}
```

위는 Java 코드이고 아래는 함께 테스트할 Kotlin 코드이다.

```kotlin
// src/main/kotlin/kr/leocat/test/kotlinjacocosample/KotlinFoo.kt
package kr.leocat.test.kotlinjacocosample

class KotlinFoo {

    fun hello(name: String): String = when {
        name == "Hello" ->  "world"
        name == "펭" ->  "하"
        name.length > 5 -> "TOO LONG"
        else -> "no one"
    }

    fun callMe() {
        println("Please, call me")
    }

}
```

```kotlin
// src/test/kotlin/kr/leocat/test/kotlinjacocosample/KotlinFooTest.kt
package kr.leocat.test.kotlinjacocosample

import org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.Test

internal class KotlinFooTest {

    private val kotlinFoo = KotlinFoo()

    @Test
    fun `partially covered hello method test`() {
        val actual = kotlinFoo.hello("펭")
        assertEquals(actual, "하")
    }

}
```

이제 기본 설정도 끝났고 코드도 준비 됐으니, 리포트를 생성하고 커버리지 체크를 실행해 보자.

```bash
$ ./gradlew --console verbose test jacocoTestReport jacocoTestCoverageVerification
> Task :compileKotlin
> Task :compileJava
> Task :processResources
> Task :classes
> Task :compileTestKotlin
> Task :compileTestJava
> Task :processTestResources NO-SOURCE
> Task :testClasses
> Task :test
> Task :jacocoTestReport

> Task :jacocoTestCoverageVerification FAILED
[ant:jacocoReport] Rule violated for bundle kotlin-jacoco-sample: instructions covered ratio is 0.5, but expected minimum is 0.9

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':jacocoTestCoverageVerification'.
> Rule violated for bundle kotlin-jacoco-sample: instructions covered ratio is 0.5, but expected minimum is 0.9

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

* Get more help at https://help.gradle.org

BUILD FAILED in 3s
8 actionable tasks: 8 executed
```

`jacocoTestReport` task는 정상적으로 실행돼서 리포트가 `build/reports/jacoco/test/html/index.html`에 생성된 것을 확인할 수 있다. 그리고 `jacocoTestCoverageVerification` task는 위에서 설정한 커버리지 체크 기준을 넘지 못 했기 때문에 실패한 것을 볼 수 있다. 설정한 90%를 넘어야 하는데, 50% 밖에 되지 않는다. 위의 실행 결과에서 0.5로 표시됐다.

{% include image.html file='/assets/img/2020-01-11-jacoco-config-jacoco-for-kotlin-and-java-project1.png' alt='JaCoCo package report' %}
{% include image.html file='/assets/img/2020-01-11-jacoco-config-jacoco-for-kotlin-and-java-project2.png' alt='JaCoCo class report' %}
{% include image.html file='/assets/img/2020-01-11-jacoco-config-jacoco-for-kotlin-and-java-project3.png' alt='JaCoCo method report' %}
{% include image.html file='/assets/img/2020-01-11-jacoco-config-jacoco-for-kotlin-and-java-project4png' alt='JaCoCo file report' %}


# 여러 task를 함께 실행

매번 `jacocoTestReport` task와 `jacocoTestCoverageVerification` task를 지정해 주려면 귀찮으니 이 task들을 하나로 묶는 `testCoverage`라는 task를 만들어 보자.

```kotlin
val testCoverage by tasks.registering {
  group = "verification"
  description = "Runs the unit tests with coverage"

  dependsOn(":test",
            ":jacocoTestReport",
            ":jacocoTestCoverageVerification")

  tasks["jacocoTestReport"].mustRunAfter(tasks["test"])
  tasks["jacocoTestCoverageVerification"].mustRunAfter(tasks["jacocoTestReport"])
}
```

`dependsOn`으로 이 task를 실행하면 `test`와 `jacocoTestReport`, `jacocoTestCoverageVerification`를 실행하도록 지정한다. 그리고, 이 task들은 실행하는 순서가 정해져 있으니 `mustRunAfter`로 순서를 지정해 준다. 테스트(`test`)를 먼저 실행하고, 그 결과로 리포트를 생성(`jacocoTestReport`)하고, 커버리지가 원하는 기준 만큼 도달했는지 체크(`jacocoTestCoverageVerification`)해야 한다. `jacocoTestCoverageVerification` task가 먼저 실행되었는데 운 나쁘게도 실패한다면 `jacocoTestReport` task가 [실행되지 않기 때문에 순서를 맞춰 주는 것이 좋다](https://reflectoring.io/jacoco/#comment-4315685529).

```
test -> jacocoTestReport -> jacocoTestCoverageVerification
```

마지막으로 이 task의 `group`을 `verification`으로 지정해 주면, 다른 Gradle 테스트 관련 task와 함께 그루핑 된 것을 볼 수 있다.

```bash
$ ./gradlew tasks
> Task :tasks

------------------------------------------------------------
Tasks runnable from root project
------------------------------------------------------------

... (생략) ...

Verification tasks
------------------
check - Runs all checks.
jacocoTestCoverageVerification - Verifies code coverage metrics based on specified rules for the test task.
jacocoTestReport - Generates code coverage report for the test task.
test - Runs the unit tests.
testCoverage - Runs the unit tests with coverage
```

{% include image.html file='/assets/img/2020-01-11-jacoco-config-jacoco-for-kotlin-and-java-project5.png' alt='Gradle tasks' %}

`testCoverage` task를 실행해 보면, 원하는 순서대로 실행되는 것을 볼 수 있다.

```bash
$ ./gradlew --console verbose testCoverage
> Task :compileKotlin
> Task :compileJava
> Task :processResources
> Task :classes
> Task :compileTestKotlin
> Task :compileTestJava
> Task :processTestResources NO-SOURCE
> Task :testClasses
> Task :test
> Task :jacocoTestReport
> Task :jacocoTestCoverageVerification
> Task :testCoverage

BUILD SUCCESSFUL in 3s
8 actionable tasks: 8 executed
```


# `test` task 실행 시 JaCoCo task 실행하도록 설정

(내가 task를 만들고도 나는 잘 못 외우니까) `testCoverage` task 마저 귀찮을 때는 `test` task를 실행할 때 마다 자동으로 JaCoCo task 들이 실행되도록 `finalizedBy`로 설정해 줄 수 있다.

```kotlin
tasks.test {
  // ... (생략) ...

  finalizedBy("jacocoTestReport")
}
tasks.jacocoTestReport {
  // ... (생략) ...

  finalizedBy("jacocoTestCoverageVerification")
}
```

이제 `test` task가 실행될 때 마다 자동으로 `jacocoTestReport` task와 `jacocoTestCoverageVerification` task가 순서대로 실행된다.


# 커버리지 기준 설정

위에서 간단히 넘어간 `jacocoTestCoverageVerification` task의 상세 설정을 살펴 보자. `violationRules`로 커버리지 기준을 설정하는 룰을 정의할 수 있다.

```kotlin
tasks.jacocoTestCoverageVerification {
  violationRules {
    rule {
      // 'element'가 없으면 전체 파일을 합친 값이다.
      limit {
        // 'counter'를 지정하지 않으면 default는 'INSTRUCTION'
        // 'value'를 지정하지 않으면 default는 'COVEREDRATIO'
        maximum = "0.5".toBigDecimal()
      }
    }

    rule {
      // 룰을 간단히 켜고 끌 수 있다.
      enabled = true

      // 룰을 체크할 단위는 클래스 단위
      element = "CLASS"

      // 브랜치 커버리지를 최소한 90% 만족시켜야 한다.
      limit {
        counter = "BRANCH"
        value = "COVEREDRATIO"
        minimum = "0.9".toBigDecimal()
      }

      // 라인 커버리지를 최소한 80% 만족시켜야 한다.
      limit {
        counter = "LINE"
        value = "COVEREDRATIO"
        minimum = "0.8".toBigDecimal()
      }

      // 빈 줄을 제외한 파일의 라인수를 최대 200라인으로 제한한다.
      limit {
        counter = "LINE"
        value = "TOTALCOUNT"
        maximum = "200".toBigDecimal()
      }
    }
  }
}
```

설정 가능한 `counter` 아래와 같다. ([JacocoLimit counter](https://docs.gradle.org/current/javadoc/org/gradle/testing/jacoco/tasks/rules/JacocoLimit.html#getCounter--) 참고)

- LINE: 빈 줄을 제외한 실제 코드의 라인 수
- BRANCH: 조건문의 분기 수
- CLASS: 클래스 수
- METHOD: 메소드 수
- INSTRUCTION(default): Java 바이트코드 명령 수. [Java bytecode instruction listings](https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings)
- COMPLEXITY: 복잡도. 자세한 복잡도 계산은 [Coverage Counters - JaCoCo docs](https://www.eclemma.org/jacoco/trunk/doc/counters.html) 참고

그리고 `value`는 아래 중에서 선택할 수 있다. ([JacocoLimit value](https://docs.gradle.org/current/javadoc/org/gradle/testing/jacoco/tasks/rules/JacocoLimit.html#getValue--) 참고)

- TOTALCOUNT: 전체 개수
- MISSEDCOUNT: 커버되지 않은 개수
- COVEREDCOUNT: 커버된 개수
- MISSEDRATIO: 커버되지 않은 비율. 0부터 1 사이의 숫자로, 1이 100%이다.
- COVEREDRATIO(default): 커버된 비율. 0부터 1 사이의 숫자로, 1이 100%이다.

테스트를 돌려보면 아래와 같은 실패 결과를 볼 수 있다. 브랜치 커버리지 90%를 원했지만 30% 밖에 되지 못 하고, 라인 커버리지는 50% 밖에 되지 못 해서 실패했다.

```bash
$ ./gradlew --console verbose test
> Task :compileKotlin
> Task :compileJava
> Task :processResources
> Task :classes
> Task :compileTestKotlin
> Task :compileTestJava
> Task :processTestResources NO-SOURCE
> Task :testClasses
> Task :test
> Task :jacocoTestReport

> Task :jacocoTestCoverageVerification FAILED
[ant:jacocoReport] Rule violated for bundle kotlin-jacoco-sample: branches covered ratio is 0.3, but expected minimum is 0.9
[ant:jacocoReport] Rule violated for bundle kotlin-jacoco-sample: lines covered ratio is 0.5, but expected minimum is 0.8

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':jacocoTestCoverageVerification'.
> Rule violated for bundle kotlin-jacoco-sample: branches covered ratio is 0.3, but expected minimum is 0.9
  Rule violated for bundle kotlin-jacoco-sample: lines covered ratio is 0.5, but expected minimum is 0.8

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

* Get more help at https://help.gradle.org

BUILD FAILED in 2s
8 actionable tasks: 1 executed, 7 up-to-date
```

JaCoCo는 여러 룰을 위한하는 경우 처음 위반한 룰만 리포팅한다. ([Enforcing code coverage metrics](https://docs.gradle.org/current/userguide/jacoco_plugin.html#sec:jacoco_report_violation_rules))


# JaCoCo 테스트에서 제외하기

커버리지를 올리지 않아도 되는 코드들이 있다. 예를 들어, QueryDsl을 사용하면 자동으로 생성되는 구현체인 `Q*.class` 같은 파일이나, spring-batch 등의 배치 설정 파일들이 있다. 이런 파일들은 커버리지 체크에서 제외할 수 있다. `excludes`로 제외할 클래스명을 지정할 수 있고, 와일드카드(* 과 ?)를 사용할 수 있다.


# 참고

- [JaCoCo Configuration using Gradle’s Kotlin DSL](https://medium.com/@arunvelsriram/jacoco-configuration-using-gradles-kotlin-dsl-67a8870b1c68)
- [Definitive Guide to the JaCoCo Gradle Plugin](https://reflectoring.io/jacoco/)
- [Test coverage in Kotlin with Jacoco](https://kevcodez.de/posts/2018-08-19-test-coverage-in-kotlin-with-jacoco/)
- [How to configure JaCoCo for Kotlin & Java project](http://vgaidarji.me/blog/2017/12/20/how-to-configure-jacoco-for-kotlin-and-java-project/)
- [The JaCoCo Plugin - Gradle docs](https://docs.gradle.org/current/userguide/jacoco_plugin.html)
- [JacocoPluginExtension - Gradle docs](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.plugins.JacocoPluginExtension.html)
- [JacocoReport - Gradle docs](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.tasks.JacocoReport.html)
- [JacocoCoverageVerification - Gradle docs](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.tasks.JacocoCoverageVerification.html)
